name: Generate

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: What version to generate
        default: preview
        options:
        - preview
        - build8193.35
        - build8193.34
        - build8193.33
        - build8193.32
        - build8193.31
        - build8193.30
        - build8193.29
        - build8193.28
        - build8193.27
        - build8193.26
        - build8193.25
        required: true

jobs:
  generate:
    name: Generate ${{ github.event.inputs.release }} nwn files
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v3"
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_ACCESS_TOKEN  }}
      - uses: jiro4989/setup-nim-action@v1
      - uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '6.0.x'
      - name: Clone SteamRE/DepotDownloader
        run: |
          gh repo clone SteamRE/DepotDownloader
      - name: Download preview nwn:ee files
        if: github.event.inputs.release == 'preview'
        run: |
          cd DepotDownloader/DepotDownloader
          dotnet run -app 704450 -depot 704451 -beta ${{ github.event.inputs.release }} -betapassword ${{ github.event.inputs.release }}${{ github.event.inputs.release }} -username ${{ secrets.STEAM_USER }} -password ${{ secrets.STEAM_PASS }}
          cd ${{ env.GITHUB_WORKSPACE }}
          mkdir out
      - name: Download nwn:ee files
        if: github.event.inputs.release != 'preview'
        run: |
          cd DepotDownloader/DepotDownloader
          dotnet run -app 704450 -depot 704451 -beta ${{ github.event.inputs.release }} -username ${{ secrets.STEAM_USER }} -password ${{ secrets.STEAM_PASS }}
          cd ${{ env.GITHUB_WORKSPACE }}
          mkdir unpacked
      - run: nimble install neverwinter -y
      - name: unpack preview keyfile
        if: github.event.inputs.release == 'preview'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/9334745/data/nwn_base.key unpacked
          cp -r DepotDownloader/DepotDownloader/depots/704451/9334745/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/9334745/ovr/ ovr/
      - name: unpack build8193.35 keyfile
        if: github.event.inputs.release == 'build8193.35'
        run: |
          echo "Not stabalized yet"
      - name: unpack build8193.34 keyfile
        if: github.event.inputs.release == 'build8193.34'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7437906/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7437906/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7437906/ovr/ ovr/
      - name: unpack build8193.32 keyfile
        if: github.event.inputs.release == 'build8193.32'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7398767/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7398767/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7398767/ovr/ ovr/
      - name: unpack build8193.31 keyfile
        if: github.event.inputs.release == 'build8193.31'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7370737/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7370737/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7370737/ovr/ ovr/
      - name: unpack build8193.30 keyfile
        if: github.event.inputs.release == 'build8193.30'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7070152/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7070152/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7070152/ovr/ ovr/
      - name: unpack build8193.29 keyfile
        if: github.event.inputs.release == 'build8193.29'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6999455/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6999455/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6999455/ovr/ ovr/
      - name: unpack build8193.28 keyfile
        if: github.event.inputs.release == 'build8193.28'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6952603/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6952603/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6952603/ovr/ ovr/
      - name: unpack build8193.27 keyfile
        if: github.event.inputs.release == 'build8193.27'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6933430/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6933430/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6933430/ovr/ ovr/
      - name: unpack build8193.26 keyfile
        if: github.event.inputs.release == 'build8193.26'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6925985/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6925985/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6925985/ovr/ ovr/
      - name: unpack build8193.25 keyfile
        if: github.event.inputs.release == 'build8193.25'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6907248/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6907248/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6907248/ovr/ ovr/

      # docs and ovr folders are in place
      - name: Gather files
        run: |
          find ./ -name '*.2da' -exec cp -prv '{}' '2da' ';'
          find ./ -name '*.dds' -exec cp -prv '{}' 'dds' ';'
          find ./ -name '*.dlg' -exec cp -prv '{}' 'dlg' ';'
          find ./ -name '*.dwk' -exec cp -prv '{}' 'dwk' ';'
          find ./ -name '*.gff' -exec cp -prv '{}' 'gff' ';'
          find ./ -name '*.gui' -exec cp -prv '{}' 'gui' ';'
          find ./ -name '*.ids' -exec cp -prv '{}' 'ids' ';'
          find ./ -name '*.ini' -exec cp -prv '{}' 'ini' ';'
          find ./ -name '*.itp' -exec cp -prv '{}' 'itp' ';'
          find ./ -name '*.ltr' -exec cp -prv '{}' 'ltr' ';'
          find ./ -name '*.mdl' -exec cp -prv '{}' 'mdl' ';'
          find ./ -name '*.mod' -exec cp -prv '{}' 'mod' ';'
          find ./ -name '*.mtr' -exec cp -prv '{}' 'mtr' ';'
          find ./ -name '*.nss' -exec cp -prv '{}' 'nss' ';'
          find ./ -name '*.plt' -exec cp -prv '{}' 'plt' ';'
          find ./ -name '*.ptt' -exec cp -prv '{}' 'ptt' ';'
          find ./ -name '*.pwk' -exec cp -prv '{}' 'pwk' ';'
          find ./ -name '*.set' -exec cp -prv '{}' 'set' ';'
          find ./ -name '*.shd' -exec cp -prv '{}' 'shd' ';'
          find ./ -name '*.ssf' -exec cp -prv '{}' 'ssf' ';'
          find ./ -name '*.tga' -exec cp -prv '{}' 'tga' ';'
          find ./ -name '*.tlk' -exec cp -prv '{}' 'tlk' ';'
          find ./ -name '*.ute' -exec cp -prv '{}' 'ute' ';'
          find ./ -name '*.uti' -exec cp -prv '{}' 'uti' ';'
          find ./ -name '*.utm' -exec cp -prv '{}' 'utm' ';'
          find ./ -name '*.utp' -exec cp -prv '{}' 'utp' ';'
          find ./ -name '*.uts' -exec cp -prv '{}' 'uts' ';'
          find ./ -name '*.utt' -exec cp -prv '{}' 'utt' ';'
          find ./ -name '*.utw' -exec cp -prv '{}' 'utw' ';'
          find ./ -name '*.wok' -exec cp -prv '{}' 'wok' ';'
          cd 2da && zip -r ../2da.zip .
          cd .. && cd dds && zip -r ../dds.zip .
          cd .. && cd dlg && zip -r ../dlg.zip .
          cd .. && cd docs && zip -r ../docs.zip .
          cd .. && cd dwk && zip -r ../dwk.zip .
          cd .. && cd gff && zip -r ../gff.zip .
          cd .. && cd gui && zip -r ../gui.zip .
          cd .. && cd ids && zip -r ../ids.zip .
          cd .. && cd ini && zip -r ../ini.zip .
          cd .. && cd itp && zip -r ../itp.zip .
          cd .. && cd ltr && zip -r ../ltr.zip .
          cd .. && cd mdl && zip -r ../mdl.zip .
          cd .. && cd mod && zip -r ../mod.zip .
          cd .. && cd mtr && zip -r ../mtr.zip .
          cd .. && cd nss && zip -r ../nss.zip .
          cd .. && cd ovr && zip -r ../ovr.zip .
          cd .. && cd plt && zip -r ../plt.zip .
          cd .. && cd ptt && zip -r ../ptt.zip .
          cd .. && cd pwk && zip -r ../pwk.zip .
          cd .. && cd set && zip -r ../set.zip .
          cd .. && cd shd && zip -r ../shd.zip .
          cd .. && cd ssf && zip -r ../ssf.zip .
          cd .. && cd tga && zip -r ../tga.zip .
          cd .. && cd tlk && zip -r ../tlk.zip .
          cd .. && cd ute && zip -r ../ute.zip .
          cd .. && cd uti && zip -r ../uti.zip .
          cd .. && cd utm && zip -r ../utm.zip .
          cd .. && cd utp && zip -r ../utp.zip .
          cd .. && cd uts && zip -r ../uts.zip .
          cd .. && cd utt && zip -r ../utt.zip .
          cd .. && cd utw && zip -r ../utw.zip .
          cd .. && cd wok && zip -r ../wok.zip .

      - name: prerelease
        if: github.event.inputs.release == 'preview'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          tag_name: release/${{ github.event.inputs.release }}
          prerelease: true
          files: |
            2da.zip
            dds.zip
            dlg.zip
            docs.zip
            dwk.zip
            gff.zip
            gui.zip
            ids.zip
            ini.zip
            itp.zip
            ltr.zip
            mdl.zip
            mod.zip
            mtr.zip
            nss.zip
            ovr.zip
            plt.zip
            ptt.zip
            pwk.zip
            set.zip
            shd.zip
            ssf.zip
            tga.zip
            tlk.zip
            ute.zip
            uti.zip
            utm.zip
            utp.zip
            uts.zip
            utt.zip
            utw.zip
            wok.zip

      - name: Release
        if: github.event.inputs.release != 'preview'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          tag_name: release/${{ github.event.inputs.release }}
          files: |
            2da.zip
            dds.zip
            dlg.zip
            docs.zip
            dwk.zip
            gff.zip
            gui.zip
            ids.zip
            ini.zip
            itp.zip
            ltr.zip
            mdl.zip
            mod.zip
            mtr.zip
            nss.zip
            ovr.zip
            plt.zip
            ptt.zip
            pwk.zip
            set.zip
            shd.zip
            ssf.zip
            tga.zip
            tlk.zip
            ute.zip
            uti.zip
            utm.zip
            utp.zip
            uts.zip
            utt.zip
            utw.zip
            wok.zip

#      # wok
#      # gather wok files
#      - name: Gather wok files
#        run: |
#          find ./ -name '*.wok' -exec cp -prv '{}' '.' ';'
#      # commit
#      - uses: EndBug/add-and-commit@v9
#        with:
#          add: "-- . ':!unpacked'"
#          message: 'CI: ${{ github.event.inputs.release }}'
#          new_branch: '${{ github.event.inputs.release }}/wok'
#          committer_name: GitHub Actions
#          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
#      - run: zip wok.zip `find . -name "*.wok"` -x unpacked/
#      - uses: actions/upload-artifact@v2
#        with:
#          name: wok
#          path: wok.zip
#      - name: Cleanup
#        run: |
#          find . -type f -iname '*.wok' -delete
#          find . -type f -iname '*.zip' -delete
#          git checkout main
#
#      # At the very end, create a release with all artifacts


#