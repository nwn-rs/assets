name: Generate

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: What version to generate
        default: preview
        options:
        - preview
        - build8193.35
        - build8193.34
        - build8193.33
        - build8193.32
        - build8193.31
        - build8193.30
        - build8193.29
        - build8193.28
        - build8193.27
        - build8193.26
        - build8193.25
        required: true

jobs:
  generate:
    name: Generate ${{ github.event.inputs.release }} nwn files
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v3"
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_ACCESS_TOKEN  }}
      - uses: jiro4989/setup-nim-action@v1
      - uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '6.0.x'
      - name: Clone SteamRE/DepotDownloader
        run: |
          gh repo clone SteamRE/DepotDownloader
      - name: Download preview nwn:ee files
        if: github.event.inputs.release == 'preview'
        run: |
          cd DepotDownloader/DepotDownloader
          dotnet run -app 704450 -depot 704451 -beta ${{ github.event.inputs.release }} -betapassword ${{ github.event.inputs.release }}${{ github.event.inputs.release }} -username ${{ secrets.STEAM_USER }} -password ${{ secrets.STEAM_PASS }}
          cd ${{ env.GITHUB_WORKSPACE }}
          mkdir out
      - name: Download nwn:ee files
        if: github.event.inputs.release != 'preview'
        run: |
          cd DepotDownloader/DepotDownloader
          dotnet run -app 704450 -depot 704451 -beta ${{ github.event.inputs.release }} -username ${{ secrets.STEAM_USER }} -password ${{ secrets.STEAM_PASS }}
          cd ${{ env.GITHUB_WORKSPACE }}
          mkdir unpacked
      - run: nimble install neverwinter -y
      - name: unpack preview keyfile
        if: github.event.inputs.release == 'preview'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/9334745/data/nwn_base.key unpacked
      - name: unpack build8193.35 keyfile
        if: github.event.inputs.release == 'build8193.35'
        run: |
          echo "Not stabalized yet"
      - name: unpack build8193.34 keyfile
        if: github.event.inputs.release == 'build8193.34'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7437906/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7437906/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7437906/lang/en/ovr/ ovr/
      - name: unpack build8193.32 keyfile
        if: github.event.inputs.release == 'build8193.32'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7398767/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7398767/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7398767/lang/en/ovr/ ovr/
      - name: unpack build8193.31 keyfile
        if: github.event.inputs.release == 'build8193.31'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7370737/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7370737/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7370737/lang/en/ovr/ ovr/
      - name: unpack build8193.30 keyfile
        if: github.event.inputs.release == 'build8193.30'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/7070152/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7070152/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/7070152/lang/en/ovr/ ovr/
      - name: unpack build8193.29 keyfile
        if: github.event.inputs.release == 'build8193.29'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6999455/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6999455/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6999455/lang/en/ovr/ ovr/
      - name: unpack build8193.28 keyfile
        if: github.event.inputs.release == 'build8193.28'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6952603/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6952603/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6952603/lang/en/ovr/ ovr/
      - name: unpack build8193.27 keyfile
        if: github.event.inputs.release == 'build8193.27'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6933430/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6933430/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6933430/lang/en/ovr/ ovr/
      - name: unpack build8193.26 keyfile
        if: github.event.inputs.release == 'build8193.26'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6925985/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6925985/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6925985/lang/en/ovr/ ovr/
      - name: unpack build8193.25 keyfile
        if: github.event.inputs.release == 'build8193.25'
        run: |
          nwn_key_unpack DepotDownloader/DepotDownloader/depots/704451/6907248/data/nwn_base.key unpacked/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6907248/lang/en/docs/ docs/
          cp -r DepotDownloader/DepotDownloader/depots/704451/6907248/lang/en/ovr/ ovr/
      # doc
      # gather doc files
      - name: Gather doc files
        run: |
          cp -r docs/ ../
      # commit
      - uses: EndBug/add-and-commit@v9
        with:
          add: "-- . ':!unpacked' ':!DepotDownloader' ':!ovr' ':!docs'"
          message: 'CI: ${{ github.event.inputs.release }}'
          new_branch: '${{ github.event.inputs.release }}/doc'
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
      - run: zip doc.zip . -x unpacked/ -x DepotDownloader/
      - uses: actions/upload-artifact@v2
        with:
          name: doc
          path: doc.zip
      - name: Cleanup
        run: |
          find . -type f -iname '*.zip' -delete
          rm -r docs/
          git checkout main
      # doc
      # gather ovr files
      - name: Gather ovr files
        run: |
          cp -r ovr/ ../
          rm -r ovr/
      # commit
      - uses: EndBug/add-and-commit@v9
        with:
          add: "-- . ':!unpacked' ':!DepotDownloader'"
          message: 'CI: ${{ github.event.inputs.release }}'
          new_branch: '${{ github.event.inputs.release }}/ovr'
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
      - run: zip ovr.zip . -x unpacked/ -x DepotDownloader/
      - uses: actions/upload-artifact@v2
        with:
          name: ovr
          path: ovr.zip
      - name: Cleanup
        run: |
          find . -type f -iname '*.zip' -delete
          rm -r ovr/
          git checkout main
      - name: cleanup repo
        run: |
          rm -r DepotDownloader
      # 2da
      # gather 2da files
      - name: Gather 2da files
        run: |
          find ./ -name '*.2da' -exec cp -prv '{}' '.' ';'
      # commit
      - uses: EndBug/add-and-commit@v9
        with:
          add: "-- . ':!unpacked'"
          message: 'CI: ${{ github.event.inputs.release }}'
          new_branch: '${{ github.event.inputs.release }}/2da'
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
      - run: zip 2da.zip `find . -name "*.2da"` -x unpacked/
      - uses: actions/upload-artifact@v2
        with:
          name: 2da
          path: 2da.zip
      - name: Cleanup
        run: |
          find . -type f -iname '*.2da' -delete
          find . -type f -iname '*.zip' -delete
          git checkout main

      # dds
      # gather dds files
      - name: Gather dds files
        run: |
          find ./ -name '*.dds' -exec cp -prv '{}' '.' ';'
      # commit
      - uses: EndBug/add-and-commit@v9
        with:
          add: "-- . ':!unpacked'"
          message: 'CI: ${{ github.event.inputs.release }}'
          new_branch: '${{ github.event.inputs.release }}/dds'
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
      - run: zip dds.zip `find . -name "*.dds"` -x unpacked/
      - uses: actions/upload-artifact@v2
        with:
          name: dds
          path: dds.zip
      - name: Cleanup
        run: |
          find . -type f -iname '*.dds' -delete
          find . -type f -iname '*.zip' -delete
          git checkout main

      # dlg
      # gather dlg files
      - name: Gather dlg files
        run: |
          find ./ -name '*.dlg' -exec cp -prv '{}' '.' ';'
      # commit
      - uses: EndBug/add-and-commit@v9
        with:
          add: "-- . ':!unpacked'"
          message: 'CI: ${{ github.event.inputs.release }}'
          new_branch: '${{ github.event.inputs.release }}/dlg'
          committer_name: GitHub Actions
          committer_email: 41898282+github-actions[bot]@users.noreply.github.com
      - run: zip dlg.zip `find . -name "*.dlg"` -x unpacked/
      - uses: actions/upload-artifact@v2
        with:
          name: dlg
          path: dlg.zip
      - name: Cleanup
        run: |
          find . -type f -iname '*.dlg' -delete
          find . -type f -iname '*.zip' -delete
          git checkout main


      # At the very end, create a release with all artifacts
      - uses: actions/download-artifact@v3
        with:
          name: 2da
      - uses: actions/download-artifact@v3
        with:
          name: dds
      - uses: actions/download-artifact@v3
        with:
          name: dlg
      - uses: actions/download-artifact@v3
        with:
          name: doc
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: dwk
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: gff
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: gui
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ids
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ini
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: itp
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ltr
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: mdl
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: mod
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: mtr
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: nss
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ovr
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: plt
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ptt
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: pwk
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: set
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: shd
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ssf
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: tga
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: tlk
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: ute
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: uti
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: utm
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: utp
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: uts
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: utt
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: utw
      #- uses: actions/download-artifact@v3
      #  with:
      #    name: wok
      - name: prerelease
        if: github.event.inputs.release == 'preview'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          generate_release_notes: true
          tag_name: release/${{ github.event.inputs.release }}
          prerelease: true
          files: |
            2da.zip
            dds.zip
            dlg.zip
            doc.zip
#dwk.zip
#gff.zip
#gui.zip
#ids.zip
#ini.zip
#itp.zip
#ltr.zip
#mdl.zip
#mod.zip
#mtr.zip
#nss.zip
#ovr.zip
#plt.zip
#ptt.zip
#pwk.zip
#set.zip
#shd.zip
#ssf.zip
#tga.zip
#tlk.zip
#ute.zip
#uti.zip
#utm.zip
#utp.zip
#uts.zip
#utt.zip
#utw.zip
#wok.zip

      - name: Release
        if: github.event.inputs.release != 'preview'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          generate_release_notes: true
          tag_name: release/v${{ github.event.inputs.release }}
          files: |
            2da.zip
            dds.zip
            dlg.zip
            doc.zip
#dwk.zip
#gff.zip
#gui.zip
#ids.zip
#ini.zip
#itp.zip
#ltr.zip
#mdl.zip
#mod.zip
#mtr.zip
#nss.zip
#ovr.zip
#plt.zip
#ptt.zip
#pwk.zip
#set.zip
#shd.zip
#ssf.zip
#tga.zip
#tlk.zip
#ute.zip
#uti.zip
#utm.zip
#utp.zip
#uts.zip
#utt.zip
#utw.zip
#wok.zip
